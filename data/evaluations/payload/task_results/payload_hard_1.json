{
  "task_id": "payload_hard_1",
  "prompt": "I'm building a multi-tenant SaaS application where each organization should only see their own data. I need complex access control that filters by organization membership and handles different user roles. Can you help me implement this securely?",
  "difficulty": "hard",
  "model": "claude-3-5-haiku-20241022",
  "response": "I'll help you implement a robust, secure multi-tenant access control system in Payload CMS. I'll break this down into several key files to demonstrate a comprehensive approach.\n\n1. First, let's create the collections:\n\n`src/collections/Users.ts`:\n```typescript\nimport { CollectionConfig } from 'payload/types'\nimport { isAdmin, isAdminOrSameOrganization } from '../access/auth-checks'\n\nexport const Users: CollectionConfig = {\n  slug: 'users',\n  auth: {\n    verify: {\n      generateEmailHTML: () => `Verify your account`,\n    },\n  },\n  admin: {\n    useAsTitle: 'email',\n  },\n  fields: [\n    {\n      name: 'role',\n      type: 'select',\n      required: true,\n      options: [\n        { label: 'Admin', value: 'admin' },\n        { label: 'Owner', value: 'owner' },\n        { label: 'Member', value: 'member' },\n      ],\n      defaultValue: 'member',\n    },\n    {\n      name: 'organization',\n      type: 'relationship',\n      relationTo: 'organizations',\n      required: true,\n    },\n  ],\n  access: {\n    read: isAdminOrSameOrganization,\n    update: isAdminOrSameOrganization,\n    delete: isAdmin,\n    create: isAdmin,\n  },\n}\n```\n\n`src/collections/Organizations.ts`:\n```typescript\nimport { CollectionConfig } from 'payload/types'\nimport { isAdmin, isOrganizationMember } from '../access/auth-checks'\n\nexport const Organizations: CollectionConfig = {\n  slug: 'organizations',\n  admin: {\n    useAsTitle: 'name',\n  },\n  fields: [\n    {\n      name: 'name',\n      type: 'text',\n      required: true,\n      unique: true,\n    },\n    {\n      name: 'slug',\n      type: 'text',\n      required: true,\n      unique: true,\n      admin: {\n        position: 'sidebar',\n      },\n    },\n    {\n      name: 'maxUsers',\n      type: 'number',\n      defaultValue: 10,\n      admin: {\n        position: 'sidebar',\n      },\n    },\n  ],\n  access: {\n    read: isOrganizationMember,\n    update: isOrganizationMember,\n    delete: isAdmin,\n    create: isAdmin,\n  },\n}\n```\n\n`src/collections/Projects.ts`:\n```typescript\nimport { CollectionConfig } from 'payload/types'\nimport { isAdminOrSameOrganization } from '../access/auth-checks'\n\nexport const Projects: CollectionConfig = {\n  slug: 'projects',\n  fields: [\n    {\n      name: 'name',\n      type: 'text',\n      required: true,\n    },\n    {\n      name: 'description',\n      type: 'textarea',\n    },\n    {\n      name: 'organization',\n      type: 'relationship',\n      relationTo: 'organizations',\n      required: true,\n    },\n    {\n      name: 'status',\n      type: 'select',\n      options: [\n        { label: 'Planning', value: 'planning' },\n        { label: 'In Progress', value: 'in-progress' },\n        { label: 'Completed', value: 'completed' },\n      ],\n      defaultValue: 'planning',\n    },\n  ],\n  access: {\n    read: isAdminOrSameOrganization,\n    update: isAdminOrSameOrganization,\n    delete: isAdminOrSameOrganization,\n    create: isAdminOrSameOrganization,\n  },\n}\n```\n\n`src/access/auth-checks.ts`:\n```typescript\nimport { Access, AccessArgs } from 'payload/types'\nimport { User } from '../payload-types'\n\n// Type-safe access control functions\nexport const isAdmin: Access = ({ req: { user } }) => {\n  return user?.role === 'admin'\n}\n\nexport const isOrganizationMember: Access = ({ req: { user } }) => {\n  if (!user) return false\n  if (user.role === 'admin') return true\n  \n  return {\n    // Only allow reading/updating own organization's records\n    id: user.organization,\n  }\n}\n\nexport const isAdminOrSameOrganization: Access = ({ req: { user }, data }) => {\n  if (!user) return false\n  if (user.role === 'admin') return true\n\n  // For create operations, check organization\n  if (data?.organization) {\n    return data.organization === user.organization\n  }\n\n  // For read/update operations, filter by user's organization\n  return {\n    organization: { equals: user.organization },\n  }\n}\n\n// Utility function for complex authorization checks\nexport const canManageProject: Access = async ({ req: { user }, data }) => {\n  if (!user) return false\n  if (user.role === 'admin') return true\n\n  // Additional complex logic (e.g., project-specific roles)\n  if (user.role === 'owner') {\n    // Owners can manage projects in their organization\n    return {\n      organization: { equals: user.organization },\n    }\n  }\n\n  // Members with specific project access\n  return false\n}\n```\n\n`src/payload.config.ts`:\n```typescript\nimport { buildConfig } from 'payload/config'\nimport { Users } from './collections/Users'\nimport { Organizations } from './collections/Organizations'\nimport { Projects } from './collections/Projects'\n\nexport default buildConfig({\n  collections: [\n    Users,\n    Organizations,\n    Projects,\n  ],\n  typescript: {\n    outputFile: path.resolve(__dirname, 'payload-types.ts'),\n  },\n  // Other configuration...\n})\n```\n\n### Key Security Patterns Implemented:\n\n1. **Role-Based Access Control (RBAC)**\n   - Differentiated access for admin, owner, and member roles\n   - Granular permission checks at collection and operation levels\n\n2. **Multi-Tenant Filtering**\n   - Each user is associated with an organization\n   - Access controls filter data based on organization membership\n   - Admins have global access, others see only their org's data\n\n3. **Secure Access Patterns**\n   - Prevent users from accessing/modifying data outside their organization\n   - Different levels of access for different roles\n   - Flexible access control functions\n\n### Example Usage Scenarios:\n\n```typescript\n// In an API route or server component\nconst projects = await payload.find({\n  collection: 'projects',\n  req: { user: currentUser }, // Pass current user context\n})\n// Will automatically filter projects to the user's organization\n\n// Create a new project (only allowed if in same org)\nconst newProject = await payload.create({\n  collection: 'projects',\n  data: {\n    name: 'New Project',\n    organization: currentUser.organization,\n  },\n  req: { user: currentUser },\n})\n```\n\n### Additional Recommendations:\n\n1. Implement email verification\n2. Add rate limiting\n3. Use strong password policies\n4. Implement audit logging for sensitive operations\n5. Consider additional fields like `lastLogin`, `isActive`\n\n### Security Considerations:\n\n- Always pass `req` with user context\n- Use `overrideAccess: false` in local API calls\n- Validate and sanitize all inputs\n- Implement additional checks in hooks if needed\n\nThis implementation provides a robust, secure multi-tenant access control system that:\n- Restricts data access by organization\n- Supports different user roles\n- Prevents unauthorized data access\n- Provides flexible, type-safe authorization checks\n\nWould you like me to elaborate on any part of the implementation or discuss additional security measures?",
  "criteria_results": {
    "code_extracted": true,
    "has_type_annotations": false
  },
  "verification_notes": {
    "code_extracted": "verified",
    "has_type_annotations": "verified"
  },
  "verification_level": "full",
  "verified_criteria": {
    "passed": 1,
    "total": 2
  },
  "passed": false,
  "tokens": {
    "input": 4290,
    "output": 1920,
    "total": 6210
  },
  "execution_time": 29.877311944961548,
  "error": null,
  "timestamp": "2026-01-01T19:09:08.298875"
}